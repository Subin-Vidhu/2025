/* Security-Enhanced PACS Monitor - Obfuscated */
(function(){var a=["YXV0aA==","bG9naW4=","bG9nb3V0","c2VydmljZXM=","cGluZw=="];var b={auth:atob(a[0]),login:"/api/"+atob(a[1]),logout:"/api/"+atob(a[2]),services:"/api/"+atob(a[3]),ping:"/api/"+atob(a[4])};var c=false;function d(){return c}function e(){c=true;document.getElementById("authScreen").style.display="none";document.getElementById("mainDashboard").style.display="block";f();g()}function h(){c=false;document.getElementById("authScreen").style.display="flex";document.getElementById("mainDashboard").style.display="none"}async function i(){try{var a=await fetch(b.ping,{credentials:"include"});if(a.ok){e()}else{h()}}catch(b){h()}}function j(){fetch(b.logout,{method:"POST",credentials:"include"}).then(()=>{h();if(window.refreshInterval){clearInterval(window.refreshInterval)}}).catch(()=>{h();if(window.refreshInterval){clearInterval(window.refreshInterval)}})}document.addEventListener("DOMContentLoaded",i);window.logout=j;document.getElementById("authForm").addEventListener("submit",function(a){a.preventDefault();var c=document.getElementById("secretKey").value;var d=document.getElementById("authError");fetch(b.login,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({password:c})}).then(a=>a.json()).then(a=>{if(a.success){e();d.style.display="none"}else{d.style.display="block";d.textContent=a.message||"Invalid access key. Please try again.";document.getElementById("secretKey").value="";document.getElementById("secretKey").focus()}}).catch(a=>{console.error("Authentication error:",a);d.style.display="block";d.textContent="Authentication failed. Please try again.";document.getElementById("secretKey").value="";document.getElementById("secretKey").focus()})});var k=[];var l="all";var m="";var n=false;var o=250;var p=800;async function f(){if(!d())return;try{var a=await fetch(b.services,{credentials:"include"});if(a.status===401){h();return}k=await a.json();q();r()}catch(c){console.error("Load failed",c);h()}}function r(){var a=k.length;var b=k.filter(a=>a.last_status==="up").length;var c=k.filter(a=>a.last_status==="down").length;var d=k.filter(a=>a.last_latency_ms>0).map(a=>a.last_latency_ms);var e=d.length?Math.round(d.reduce((a,b)=>a+b,0)/d.length):0;document.getElementById("totalServices").textContent=a;document.getElementById("upServices").textContent=b;document.getElementById("downServices").textContent=c;document.getElementById("avgLatency").textContent=e+"ms"}function s(a){if(a==null)return"";if(a>=p)return"critical";if(a>=o)return"warn";return"ok"}function t(a){var b=(new Date()-new Date(a))/1000;if(b<60)return Math.floor(b)+"s ago";if(b<3600)return Math.floor(b/60)+"m ago";if(b<86400)return Math.floor(b/3600)+"h ago";return Math.floor(b/86400)+"d ago"}function q(){document.getElementById("cards").innerHTML="";var a=Date.now();var b=k.filter(b=>{if(l!=="all"){if(l==="up")return b.last_status==="up";if(l==="down")return b.last_status==="down";if(l==="unknown")return b.last_status==="unknown"||!b.last_status;if(l==="slow")return b.last_latency_ms>o;if(l==="changed"){if(!b.last_change)return false;var c=a-new Date(b.last_change).getTime();return c<300000}}return true}).filter(a=>{if(!m)return true;return a.name.toLowerCase().includes(m.toLowerCase())||a.host.toLowerCase().includes(m.toLowerCase())});b.forEach(a=>{var b=a.last_error?`<div class="error-text">Error: ${a.last_error}</div>`:"";var c=a.port&&![80,443].includes(a.port)?`:${a.port}`:"";var d=s(a.last_latency_ms);var e=a.env?`<span class="env-badge">${a.env.toUpperCase()}</span>`:"";var f=document.createElement("div");f.className=`card ${a.last_status||"unknown"}`;f.innerHTML=`<div class="card-header-row"><div class="left-head"><div class="svc-name">${a.name}</div><div class="host-line">${a.host}${c}</div></div>${e}</div><div class="status-badge ${a.last_status||"unknown"}">${(a.last_status||"unknown").toUpperCase()}</div><div class="metrics"><div class="metric"><div class="metric-value">${a.last_http_status||"---"}</div><div class="metric-label">HTTP</div></div><div class="metric latency ${d}"><div class="metric-value">${a.last_latency_ms!=null?a.last_latency_ms+"ms":"---"}</div><div class="metric-label">LAT</div><canvas class="sparkline" data-spark="${a.id}"></canvas></div></div>${b}<div class="timestamp">ðŸ“… Changed: ${a.last_change?t(a.last_change):"â€”"} â€¢ âœ… Checked: ${a.last_checked?t(a.last_checked):"â€”"}</div><footer><button data-edit="${a.id}" class="secondary">Edit</button><button data-del="${a.id}" class="danger">Delete</button><button data-check="${a.id}" class="success">Check</button></footer>`;f.addEventListener("click",b=>{var c=b.target;if(c.dataset.edit)u(c.dataset.edit);else if(c.dataset.del)v(c.dataset.del);else if(c.dataset.check)w(c.dataset.check)});document.getElementById("cards").appendChild(f)});b.forEach(a=>x(a.id))}async function u(a){var b=k.find(b=>b.id===a);if(!b)return;document.getElementById("svcForm").id.value=b.id;document.getElementById("svcForm").name.value=b.name;document.getElementById("svcForm").host.value=b.host;document.getElementById("svcForm").port.value=b.port||"";document.getElementById("svcForm").protocol.value=b.protocol||"https";document.getElementById("svcForm").path.value=b.path||"/";document.getElementById("svcForm").env.value=b.env||"";document.getElementById("svcForm").active.checked=b.active!==false;document.getElementById("svcDialog").showModal()}async function v(a){if(!confirm("Delete this service?"))return;try{await fetch("/api/services/"+a,{method:"DELETE",credentials:"include"});await f()}catch(b){alert("Delete failed")}}async function w(a){var c=document.querySelector(`[data-check="${a}"]`);var d=c.closest(".card");var e=c.textContent;try{c.textContent="Checking...";c.disabled=true;d.classList.add("checking");await fetch("/api/check/"+a,{credentials:"include"});setTimeout(async()=>{try{var e=await fetch(`/api/services/${a}`,{credentials:"include"});if(e.ok){var f=await e.json();y(a,f);r();c.textContent="Check";c.disabled=false;d.classList.remove("checking")}}catch(g){console.error("Failed to refresh single service:",g);c.textContent="Check";c.disabled=false;d.classList.remove("checking")}},1500)}catch(f){console.error("Check failed:",f);c.textContent=e;c.disabled=false}}async function x(a){try{var c=await fetch("/api/history/"+a,{credentials:"include"});if(!c.ok){if(c.status===401)h();return}var d=await c.json();var e=document.querySelector(`canvas[data-spark="${a}"]`);if(!e)return;var f=d.latency_ms||[];z(e,f)}catch(g){console.warn("spark failed",g)}}function y(a,b){var c=document.querySelectorAll(".card");var d=null;for(var e of c){var f=e.querySelector(`[data-edit="${a}"]`);if(f){d=e;break}}if(!d)return;var g=b.last_error?`<div class="error-text">Error: ${b.last_error}</div>`:"";var h=b.port&&![80,443].includes(b.port)?`:${b.port}`:"";var i=s(b.last_latency_ms);var j=b.env?`<span class="env-badge">${b.env.toUpperCase()}</span>`:"";d.innerHTML=`<div class="card-header-row"><div class="left-head"><div class="svc-name">${b.name}</div><div class="host-line">${b.host}${h}</div></div>${j}</div><div class="status-badge ${b.last_status||"unknown"}">${(b.last_status||"unknown").toUpperCase()}</div><div class="metrics"><div class="metric"><div class="metric-value">${b.last_http_status||"---"}</div><div class="metric-label">HTTP</div></div><div class="metric latency ${i}"><div class="metric-value">${b.last_latency_ms!=null?b.last_latency_ms+"ms":"---"}</div><div class="metric-label">LAT</div><canvas class="sparkline" data-spark="${b.id}"></canvas></div></div>${g}<div class="timestamp">ðŸ“… Changed: ${b.last_change?t(b.last_change):"â€”"} â€¢ âœ… Checked: ${b.last_checked?t(b.last_checked):"â€”"}</div><footer><button data-edit="${b.id}" class="secondary">Edit</button><button data-del="${b.id}" class="danger">Delete</button><button data-check="${b.id}" class="success">Check</button></footer>`;d.className=`card ${b.last_status||"unknown"}`}function z(a,b){if(!b.length)return;var c=a.getContext("2d");a.width=a.offsetWidth;a.height=a.offsetHeight;var d=Math.max(...b);var e=Math.min(...b);var f=a.width/(b.length-1);var g=a.height-2;c.strokeStyle="#00d4ff";c.lineWidth=1.5;c.beginPath();for(var h=0;h<b.length;h++){var i=h*f;var j=d===e?g/2:g-((b[h]-e)/(d-e))*g;if(h===0){c.moveTo(i,j)}else{c.lineTo(i,j)}}c.stroke()}function g(){document.getElementById("svcForm").addEventListener("submit",async a=>{a.preventDefault();var c={id:document.getElementById("svcForm").id.value||document.getElementById("svcForm").name.value.trim(),name:document.getElementById("svcForm").name.value.trim(),host:document.getElementById("svcForm").host.value.trim(),port:document.getElementById("svcForm").port.value?Number(document.getElementById("svcForm").port.value):undefined,protocol:document.getElementById("svcForm").protocol.value,path:document.getElementById("svcForm").path.value.trim()||"/",env:document.getElementById("svcForm").env.value.trim(),active:document.getElementById("svcForm").active.checked};await fetch(b.services,{method:"POST",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify(c)});document.getElementById("svcDialog").close();await f()});document.getElementById("cancelBtn").onclick=()=>document.getElementById("svcDialog").close();document.getElementById("addBtn").onclick=()=>u("");document.getElementById("refreshDataBtn").onclick=()=>f();document.getElementById("refreshBtn").onclick=async()=>{document.getElementById("refreshBtn").textContent="ðŸ”„ Checking...";document.getElementById("refreshBtn").disabled=true;try{await A()}finally{document.getElementById("refreshBtn").textContent="ðŸ”„ Check All";document.getElementById("refreshBtn").disabled=false}};document.addEventListener("click",a=>{if(a.target.classList&&a.target.classList.contains("filt")){document.querySelectorAll(".filt").forEach(a=>a.classList.remove("active"));a.target.classList.add("active");l=a.target.dataset.filter;q()}});var a=document.getElementById("searchInput");if(a){a.addEventListener("input",()=>{m=a.value;q()})}var c=document.getElementById("compactToggle");if(c){c.addEventListener("change",()=>{n=c.checked;document.body.classList.toggle("compact",n)})}document.addEventListener("keydown",a=>{if(!d())return;if(a.ctrlKey&&a.key.toLowerCase()==="k"){a.preventDefault();var b=document.getElementById("searchInput");if(b)b.focus()}else if(a.key==="r"){document.getElementById("refreshDataBtn").click()}else if(a.key==="a"){document.getElementById("refreshBtn").click()}else if(a.key==="n"){document.getElementById("addBtn").click()}else if(a.key==="u"){B("up")}else if(a.key==="d"){B("down")}else if(a.key==="c"){B("changed")}else if(a.key==="l"){B("slow")}else if(a.key==="?"){B("unknown")}});window.refreshInterval=setInterval(f,15000)}async function A(){await fetch("/api/check",{credentials:"include"});setTimeout(f,2000)}function B(a){var b=document.querySelector(`.filt[data-filter="${a}"]`);if(b){b.click()}}window.triggerCheckNow=A})();
